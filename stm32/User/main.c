#include "stm32f10x.h"
//#include "config.h"
#include "./HUB08/hub08.h"
#include "./GeneralTim/bsp_GeneralTim.h"

uint32_t time = 0; // ms flag
	unsigned char temp_up, temp_down;

void led_image_show(void);
void line_choose(unsigned char num);
void led_line_show(void);
void line_load(void);
void SD_read(void);

//unsigned char buffer[256] = {	
//			0x00,0x00,0x00,0x00,0xE0,0xFF,0x03,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0x07,0x00,
//			0x00,0x00,0x00,0x00,0xF8,0xFF,0x07,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0x07,0x00,
//			0x00,0x00,0x00,0x00,0xFC,0xFF,0x0F,0x00,0x00,0x00,0x00,0x00,0xFE,0xFF,0x0F,0x00,
//			0x00,0x00,0x00,0x00,0xFE,0xFF,0x0F,0x00,0x00,0x00,0x00,0x00,0xFE,0xFF,0x1F,0x00,
//			0x00,0x00,0x00,0x00,0xFE,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0x1F,0x00,
//			0x00,0x00,0x00,0x00,0xF8,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0x1F,0x00,
//			0x00,0x00,0x00,0x00,0xF0,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0xF0,0xFF,0x1F,0x00,
//			0x00,0x00,0x00,0x00,0xE0,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0x1F,0x00,
//			0x00,0x00,0x00,0x00,0xC0,0xFD,0x1F,0x00,0x00,0x00,0x00,0x00,0xC0,0xFD,0x1F,0x00,
//			0x00,0x00,0x00,0x00,0xC0,0xFF,0x1F,0x00,0x00,0x00,0x00,0x00,0x80,0xFF,0x1F,0x00,
//			0x00,0x00,0x80,0x03,0x80,0xFF,0x13,0x00,0x00,0x00,0xE0,0x07,0x80,0xFF,0x03,0x00,
//			0x00,0x00,0xF0,0x07,0xC0,0xFF,0x03,0x00,0x00,0x00,0xF0,0x07,0xF0,0xFF,0x07,0x00,
//			0x00,0x00,0xF0,0x07,0xF0,0xFF,0x07,0x00,0x00,0x00,0xF0,0x1F,0xF0,0xFF,0x03,0x00,
//			0x00,0x00,0xE0,0xFF,0xF9,0xFF,0x03,0x00,0x00,0x00,0xC0,0xFF,0xFF,0xFF,0x07,0x00,
//			0x00,0x00,0x00,0xFF,0xFF,0xFF,0x07,0x00,0x00,0x00,0x00,0xFE,0xFF,0xFF,0x07,0x00,
//			0x00,0x00,0x00,0xFE,0xFF,0xFF,0x67,0x00,0x00,0x00,0x00,0xFE,0xFF,0xFF,0x3F,0x00,
//			};

unsigned char buffer[256] = {	
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xE0,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x1F, 0x80, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x1F, 0x00,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xC0,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x3F, 0xC0, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x0F, 0xC0,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0x7F, 0x00, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1E, 0xC0,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x0F, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x03, 0x00,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x3F, 0xF0,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x1F, 0xF8, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0x3F, 0xF0,
			0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0xC1, 0x00, 0x00, 0x00, 0x80, 0xFF, 0xFF, 0xFF, 0x07
			};

int main(void)
{
	HUB08_init();

	refresh_TIM_Init(); //TIM init 20HZ
    while (1)
    {    
		if ( time >= 20 )
		{
			SD_read();		//load next image
			time = 0;
		}
		led_image_show();
    }
}

void led_image_show(void)
{
	unsigned char line = 0;
	for(line=0;line<16;line++)
	{
		led_line_show();  //load a line
		OE_ENABLE;        //LED screen enable	
		LAT_SET;     
		LAT_RESET;        //output latch		
		line_choose(line);     //choose a line
		OE_DISABLE;       //LED screen disable
	}
}

void led_line_show(void)   //display one line in both side
{
	unsigned char s = 0, k = 0;

	for(s=0;s<8;s++)		 //send 8 bite to display one line in each side (64 led)
	{
		line_load();
		//temp_up = 0xff;
		//temp_down = 0xff;   //turn on all the light
		//G1 = 1;
		//G2 = 1; //don't display green

		for(k=0;k<8;k++)//give 8 bit to 595 by bit,display 8 led each side
		{			   
			R1(temp_up & 0x01);
			R2(temp_down & 0x01);      //up down sequence signal
			CLK_SET;
			CLK_RESET;
			temp_up = temp_up >> 1; 
			temp_down = temp_down >> 1; 		   
		}
	}
}

void line_choose(unsigned char num)
{
	if (num == 0)
	{
		GPIO_ResetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if (num == 1)
	{
		GPIO_SetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 2)	
	{
		GPIO_ResetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 3)	
	{
		GPIO_SetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 4)	
	{
		GPIO_ResetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 5)	
	{
		GPIO_SetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 6)	
	{
		GPIO_ResetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 7)	
	{
		GPIO_SetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 8)	
	{
		GPIO_ResetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 9)	
	{
		GPIO_SetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 10)	
	{
		GPIO_ResetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 11)	
	{
		GPIO_SetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 12)	
	{
		GPIO_ResetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 13)	
	{
		GPIO_SetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_ResetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 14)	
	{
		GPIO_ResetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
	else if(num == 15)	
	{
		GPIO_SetBits(CTRL_GPIO_PORT, A_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, B_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, C_GPIO_PIN);
		GPIO_SetBits(CTRL_GPIO_PORT, D_GPIO_PIN);
	}
}

void line_load(void)
{
	static unsigned char point = 0;
	temp_up = buffer[point];
	temp_down = buffer[point+128];
	point++;
	if(point >= 128)
		point = 0;
}

void SD_read(void)
{
	res_sd = f_open(&fnew, "out.bin", FA_OPEN_EXISTING | FA_READ);
	if(res_sd == FR_OK)
	{
		//LED_GREEN;
		printf("> open file successfully.\r\n");
		res_sd = f_read(&fnew, buffer, sizeof(ReadBuffer), &fnum); 
		if(res_sd==FR_OK)
		{
			printf("> read file successfully.\r\n",fnum);
		}
		else
		{
			printf("!!error!\n",res_sd);
		}		
	}
	else
	{
		LED_RED;
		printf("!!can't open file.\r\n");
	}
	buffer
}